<head>
  <meta charset="UTF-8">
  <meta id="viewport" name="viewport" content="initial-scale=1.0">
  <title>Far Function ( js )</title>
  <link href="css/bootstrap.min.css" rel="stylesheet">
  <link href="css/bootstrap-theme.min.css" rel="stylesheet">
  <style>
  .jumbotron {
    margin-top: 20px;
  }
  </style>
</head>
<body>

<div class="container">

  <div id="content" style="display: block;">

    <div class="jumbotron">
      <h1>Far Function ( js )</h1>
      <p>You can post server side javascript functions as node.js module which you can call in RESTful URL.</p>
    </div>

    <form role="form">
      <div class="form-group">
        <label for="moduleName">module name</label><br>
        <input id="moduleName" type="text" value=""><br>
      </div>
      <div class="form-group">
        <input type="button" value="Load" onclick="load()">
      </div>


      <div class="form-group">
        <label for="source">source</label><br>
        <textarea id="source" rows="20" style="width:100%"></textarea><br>
      </div>
      <div class="form-group">
        <input type="button" value="Save" onclick="save()"></p>
      </div>
    </form>

    <hr>

    <form role="form">
      <div class="form-group">
        <label class="radio"><input type="radio" name="method" value="GET" checked="checked">GET</label>
        <label class="radio"><input type="radio" name="method" value="POST">POST</label> 
      </div>
      <div class="form-group">
        <span id="host"></span>call/<br>
        <input id="pathModuleName" type="text" placeholder="module name" size="32">&nbsp;/<br>
        <input id="pathMethod" type="text" size="32" placeholder="function name and query parameters">
      </div>
      <div class="form-group">
        <textarea id="requestBody" rows="3" style="width:100%" placeholder="request body"></textarea>
      </div>
      <div class="form-group">
        <input type="button" value="Call" onclick="call()">
      </div>
    </form>

    <pre><code id="response">Response</code></pre>

    <hr>

    <h3 id="savedmodules">Saved Modules</h3>

    <hr>

    <h3 id="samplemodules">Sample Modules</h3>

    <hr>

    <h3 id="authenticationsetting">Authentication Setting</h3>

    <form role="form">

      <div class="form-group">
        <input id="username" type="text" value="" placeholder="new username"><br>
      </div>

      <div class="form-group">
        <input id="password" type="password" value="" placeholder="new password"><br>
      </div>

      <div class="form-group">
        <input id="rePassword" type="password" value="" placeholder="retype new password"><br>
      </div>

      <div class="form-group">
        <input type="button" value="Set" onclick="setAuth()">
      </div>

    </form>

    <hr>

    <footer><p>BY:@takahashihideki</p></footer>

  <!-- /content -->
  </div>

<!-- /container -->
</div>

<script src="//code.jquery.com/jquery-1.10.2.min.js"></script>
<script>

var load = function () {

  $.ajax( {
    url: "/admin/get/" + $( "#moduleName" ).val(),
    method: "GET",
    success: function ( data ) {
      if ( data.status ) {
        $( "#source" ).val( data.source );
      }
      else {
        alert( "Not Found" );
      }
    },
    error: function ( xhr, status, err ) {
      alert( status + "\n" + err );
    }
  } );
  
}

var save = function () {

  var execute  = false;

  if ( exists() ) {
    if ( confirm( "Overwrite it?" ) ) {
      execute = true;
    }
  }
  else {
    execute = true;
  }

  if ( execute ) {

    $.ajax( {
      url: "/admin/post/" + $( "#moduleName" ).val(),
      method: "POST",
      data: { source: $( "#source" ).val() },
      success: function ( data ) {
        if ( data.status ) {
          alert( "Saved" );
          refresh();
        }
        else {
          alert( "Error" );
        }
      },
      error: function ( xhr, status, err ) {
        alert( status + "\n" + err );
      }
    } );

  }
  
}

var refresh = function () { 

  $.ajax( {
    url: "/admin/refresh/" + $( "#moduleName" ).val(),
    method: "GET",
    success: function ( data ) {
      if ( data.status ) {
        alert( "Clear Cache" );
      }
      else {
        alert( "error" );
      }
    },
    error: function ( xhr, status, err ) {
      alert( status + "\n" + err );
    }
  } );
  
}

var exists = function () {

  var exist = false;

  $.ajax( {
    url: "/admin/exists/" + $( "#moduleName" ).val(),
    method: "GET",
    async: false,
    success: function ( data ) {
      if ( data.status ) {
        exist = true;        
      }
    },
    error: function ( xhr, status, err ) {
      alert( status + "\n" + err );
    }
  } );

  return exist;
  
}

var call = function () {

  var action = "/admin/call/" + $( "#pathModuleName" ).val() + "/" + $( "#pathMethod" ).val();   
  var method = $( "form" ).eq(1).find( "input[name=method]:checked" ).val();
  data = {};
  if ( method == "POST" ) {
    data = $.parseParams( $( "#requestBody" ).val() );
  }
  
  $.ajax( {
    url: action,
    method: method,
    async: false,
    data: data,
    dataType: "text",
    success: function ( data ) {
        $( "#response" ).text( data );
    },
    error: function ( xhr, status, err ) {
      alert( status + "\n" + err );
    }
  } );
  
}

var setAuth = function () {

  var username = $( "#username" ).val();
  var password = $( "#password" ).val();
  var rePassword = $( "#rePassword" ).val();

  if ( ! username.match( /^[\x20-\x7E]+$/ ) ) {
    alert( "username is invalid: ascii characters only" );
    
  }

  if ( ! username || ! password ) {
    alert( "username or password is empty" );
    return false;
  }

  if ( password != rePassword ) {
    alert( "passwords do not match." );
    return false;
  }

  var action = "/admin/setAuth";   

  $.ajax( {
    url: action,
    method: "POST",
    async: false,
    data: {
      username: username,
      password: password
    },
    success: function ( data ) {
      if ( data.status ) {
        alert( "Success" );
      }
      else {
        alert( "Failed to set" );
      }
    },
    error: function ( xhr, status, err ) {
      alert( status + "\n" + err );
    }
  } );
  
}

$( function () {

  // force https 127.0.0.1 is developer's local host'
  if ( window.location.protocol != "https" && ! window.location.host.match( /^127\.0\.0\.1/ )  ) {
    window.location.href = window.location.href.replace( /^http:/, "https:" ); 
    return;
  }

  $( "#host" ).text( window.location.href );

  $( "#moduleName" ).on( "keyup", function () {
    $( "#pathModuleName" ).val( $( this ).val() );
  } );

} );

/**
 * $.parseParams - parse query string paramaters into an object.
 * https://gist.github.com/kares/956897
 */
( function( $ ) {
var re = /([^&=]+)=?([^&]*)/g;
var decodeRE = /\+/g;  // Regex for replacing addition symbol with a space
var decode = function (str) {return decodeURIComponent( str.replace(decodeRE, " ") );};
$.parseParams = function(query) {
    var params = {}, e;
    while ( e = re.exec(query) ) { 
        var k = decode( e[1] ), v = decode( e[2] );
        if (k.substring(k.length - 2) === '[]') {
            k = k.substring(0, k.length - 2);
            (params[k] || (params[k] = [])).push(v);
        }
        else params[k] = v;
    }
    return params;
};
} )( jQuery );

</script>

</body>
</html>