<head>
  <meta charset="UTF-8">
  <meta id="viewport" name="viewport" content="initial-scale=1.0">
  <title>Far Function ( js )</title>
  <link href="css/bootstrap.min.css" rel="stylesheet">
  <link href="css/bootstrap-theme.min.css" rel="stylesheet">
  <style>
  .jumbotron {
    margin-top: 20px;
  }
  </style>
</head>
<body>

<div class="container">

  <div id="content" style="display: block;">

    <div class="jumbotron">
      <h1>Far Function ( js )</h1>
      <p>You can post server side javascript functions as node.js module which you can call in RESTful URL.</p>
    </div>

    <form role="form">
      <div class="form-group">
        <label for="moduleName">module name</label><br>
        <input id="moduleName" type="text" value=""><br>
      </div>
      <div class="form-group">
        <input type="button" value="Load" onclick="load()">
      </div>


      <div class="form-group">
        <label for="source">source</label><br>
        <textarea id="source" rows="20" style="width:100%"></textarea><br>
      </div>
      <div class="form-group">
        <input type="button" value="Save" onclick="save()"></p>
      </div>
    </form>

    <hr>

    <form role="form">
      <div class="form-group">
        <label class="radio"><input type="radio" name="method" value="GET" checked="checked">GET</label>
        <label class="radio"><input type="radio" name="method" value="POST">POST</label> 
      </div>
      <div class="form-group">
        <span id="host"></span>call/&nbsp;<input id="pathModuleName" type="text" placeholder="module name">&nbsp;/&nbsp;<input id="pathMethod" type="text" size="40" placeholder="function name and query parameters"><br>
      </div>
      <div class="form-group">
        <textarea id="requestBody" rows="3" style="width:100%" placeholder="request body"></textarea>
      </div>
      <div class="form-group">
        <input type="button" value="Call" onclick="call()">
      </div>
    </form>

    <pre><code id="response">Response</code></pre>

    <hr>

    <h3 id="savedmodules">Saved Modules</h3>

    <hr>

    <h3 id="samplemodules">Sample Modules</h3>

    <div style="display: none">

    <p>Request</p>

    <pre><code>//module name = foo

var request = require( "request" );

exports.get = function( req, res ) {

  var args = {
    "method": "GET",
    "url": "http://example.com/example.json", // Cross Domain !
  };
  request( args, function( error, response, body ){
    res.return( body )
  });

};</code></pre>

    <p>Call ( JSONP )</p>

    <pre><code>http://localhost/call/foo/get?callback=callback</code></pre>

    <p>Response ( JSONP )</p>

    <pre><code>callback( {
    "title": "Example Schema",
    "type": "object",
    "properties": {
        "firstName": {
            "type": "string"
        },
        "lastName": {
            "type": "string"
        },
        "age": {
            "description": "Age in years",
            "type": "integer",
            "minimum": 0
        }
    },
    "required": ["firstName", "lastName"]
} )</code></pre>

    </div>

<hr>

<h3 id="authenticationsetting">Authentication Setting</h3>


<hr>
<footer><p>@takahashihideki</p></footer>

<!-- /container -->
</div>

<script src="http://code.jquery.com/jquery-1.10.2.min.js"></script>
<script>

var load = function () {

  $.ajax( {
    url: "/get/" + $( "#moduleName" ).val(),
    method: "GET",
    success: function ( data ) {
      if ( data.status ) {
        $( "#source" ).val( data.source );
      }
      else {
        alert( "Not Found" );
      }
    },
    error: function ( xhr, status, err ) {
      alert( status + "\n" + err );
    }
  } );
  
}

var save = function () {

  var execute  = false;

  if ( exists() ) {
    if ( confirm( "Overwrite it?" ) ) {
      execute = true;
    }
  }
  else {
    execute = true;
  }

  if ( execute ) {

    $.ajax( {
      url: "/post/" + $( "#moduleName" ).val(),
      method: "POST",
      data: { source: $( "#source" ).val() },
      success: function ( data ) {
        if ( data.status ) {
          alert( "Saved" );
          refresh();
        }
        else {
          alert( "Error" );
        }
      },
      error: function ( xhr, status, err ) {
        alert( status + "\n" + err );
      }
    } );

  }
  
}

var refresh = function () { 

  $.ajax( {
    url: "/refresh/" + $( "#moduleName" ).val(),
    method: "GET",
    success: function ( data ) {
      if ( data.status ) {
        alert( "Clear Cache" );
      }
      else {
        alert( "error" );
      }
    },
    error: function ( xhr, status, err ) {
      alert( status + "\n" + err );
    }
  } );
  
}

var exists = function () {

  var exist = false;

  $.ajax( {
    url: "/exists/" + $( "#moduleName" ).val(),
    method: "GET",
    async: false,
    success: function ( data ) {
      if ( data.status ) {
        exist = true;        
      }
    },
    error: function ( xhr, status, err ) {
      alert( status + "\n" + err );
    }
  } );

  return exist;
  
}

var call = function () {

  var action = "/call/" + $( "#pathModuleName" ).val() + "/" + $( "#pathMethod" ).val();   
  var method = $( "form" ).eq(1).find( "input[type=radio]:checked" ).val();
  data = {};
  if ( method == "POST" ) {
    data = $.parseParams( $( "#requestBody" ).val() );
  }
  
  $.ajax( {
    url: action,
    method: method,
    async: false,
    data: data,
    dataType: "json",
    success: function ( data ) {
      $( "#response" ).html( JSON.stringify( data ) );
    },
    error: function ( xhr, status, err ) {
      alert( status + "\n" + err );
    }
  } );
  
}


$( function () {

  $( "#host" ).text( window.location.href );

  $( "#moduleName" ).on( "keyup", function () {
    $( "#pathModuleName" ).val( $( this ).val() );
  } );

} );

/**
 * $.parseParams - parse query string paramaters into an object.
 * https://gist.github.com/kares/956897
 */
(function($) {
var re = /([^&=]+)=?([^&]*)/g;
var decodeRE = /\+/g;  // Regex for replacing addition symbol with a space
var decode = function (str) {return decodeURIComponent( str.replace(decodeRE, " ") );};
$.parseParams = function(query) {
    var params = {}, e;
    while ( e = re.exec(query) ) { 
        var k = decode( e[1] ), v = decode( e[2] );
        if (k.substring(k.length - 2) === '[]') {
            k = k.substring(0, k.length - 2);
            (params[k] || (params[k] = [])).push(v);
        }
        else params[k] = v;
    }
    return params;
};
})(jQuery);

</script>

</body>
</html>